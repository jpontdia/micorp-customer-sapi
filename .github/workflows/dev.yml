name: Build and deploy to dev
on:
  # Triggers the workflow on push or pull request events but only for the "main" branch
  push:
  pull_request:

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

jobs:
  build-deploy:
    # The type of runner that the job will run on 
    runs-on: ubuntu-latest

    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so the job can access it
      - uses: actions/checkout@v3

      - name: Set up JDK 8
        uses: actions/setup-java@v3
        with:
          java-version: '8'
          # Available options: liberica, corretto
          distribution: 'temurin'
          check-latest: true
          #cache: 'maven'

      - name: Log in with Azure
        uses: azure/login@v1
        with:
          creds: '${{ secrets.AZURE_CREDENTIALS }}'
          
      - uses: Azure/get-keyvault-secrets@v1
        with:
          keyvault: "jpworks-keyvault" # The name of KeyVault in Azure
          secrets: '
            salesforce-principal,
            salesforce-consumerkey,
            salesforce-keystore,
            salesforce-storepassword,
            mulesoft-nexus-ee-user,
            mulesoft-nexus-ee-password,
            cicd-connectedapp-clientid,
            cicd-connectedapp-secret
            '
        id: secretmanager # ID for secrets that you will reference
      
      # Creates a settings.xml file and configure the anypoint repositories for the organization and the mulesoft EE
      - name: maven-settings-xml-action
        uses: whelk-io/maven-settings-xml-action@v21
        with:
          servers: >
            [
              {
                "id": "anypoint-exchange-v3",
                "username": "~~~Client~~~",
                "password": "${{ steps.secretmanager.outputs.cicd-connectedapp-clientid }}~?~${{ steps.secretmanager.outputs.cicd-connectedapp-secret }}" 
              },
              {
                "id": "mulesoft-enterprise-repository",
                "username": "${{ steps.secretmanager.outputs.mulesoft-nexus-ee-user }}",
                "password": "${{ steps.secretmanager.outputs.mulesoft-nexus-ee-password }}" 
              }
            ]
          repositories: >
            [
              {
                "id": "anypoint-exchange-v3",
                "name": "Assets for your anypoint organization",
                "url": "https://maven.anypoint.mulesoft.com/api/v3/maven/"
              },
              {
                "id": "mulesoft-releases",
                "name": "mulesoft-releases",
                "url": "https://repository-master.mulesoft.org/releases/"
              },
              {
                "id": "mulesoft-snapshots",
                "name": "MuleSoft Snapshot Repository",
                "url": "https://repository-master.mulesoft.org/snapshots/"
              },
              {
                "id": "mulesoft-enterprise-repository",
                "name": "MuleSoft Enterprise Repository",
                "url": "https://repository.mulesoft.org/nexus-ee/content/repositories/releases-ee/"
              }
            ]
          plugin_repositories: >
            [
              {
                "id": "mulesoft-plugins",
                "name": "Mulesoft plugins-release",
                "url": "https://repository.mulesoft.org/nexus/content/repositories/public/"
              },
              {
                "id": "central-plugins",
                "name": "plugins-release",
                "url": "https://repo1.maven.org/maven2"
              },
              {
                "id": "mulesoft-snapshots",
                "name": "MuleSoft Snapshot Repository",
                "url": "https://repository-master.mulesoft.org/snapshots/"
              },
              {
                "id": "mulesoft-plugins-release",
                "name": "Mulesoft plugins-release",
                "url": "https://repository.mulesoft.org/releases/",
                "snapshots": {
                  "enabled": "false",
                  "updatePolicy": "always",
                  "checksumPolicy": "fail"
                }
              }              
            ]
        
      - name: DEBUG - Show settings file
        run: |
          ls -la $HOME
          cat $HOME/.m2/settings.xml
          echo ${{ github.run_number }}
        
      - name: Run test cases and package
        run: |
          ## Get the git commit hash 
          commitHash=$(git rev-parse --short "$GITHUB_SHA")

          mvn package \
           -Dsalesforce.principal="${{ steps.secretmanager.outputs.salesforce-principal }}" \
           -Dsalesforce.consumerkey="${{ steps.secretmanager.outputs.salesforce-consumerkey }}" \
           -Dsalesforce.keystore="${{ steps.secretmanager.outputs.salesforce-keystore }}" \
           -Dsalesforce.storepassword="${{ steps.secretmanager.outputs.salesforce-storepassword }}"

      - name: Deploy to anypoint exchange
        run: |
          ## Deploy to anypoint exchange
          mvn deploy -DskipTests \
           -Dsalesforce.principal="${{ steps.secretmanager.outputs.salesforce-principal }}" \
           -Dsalesforce.consumerkey="${{ steps.secretmanager.outputs.salesforce-consumerkey }}" \
           -Dsalesforce.keystore="${{ steps.secretmanager.outputs.salesforce-keystore }}" \
           -Dsalesforce.storepassword="${{ steps.secretmanager.outputs.salesforce-storepassword }}"


      - name: Publish MUnit Application Coverage Report
        uses: actions/upload-artifact@master
        with:
          name: munit-application-coverage-report
          path: target/site/munit/coverage/*
      
      - name: Publish MUnit Report
        uses: actions/upload-artifact@master
        with:
          name: munit-test-report
          path: target/surefire-reports/*

      - name: Upload Jar as an artifact 
        uses: actions/upload-artifact@master
        with:
          name: artifacts
          path: target/*.jar